<!DOCTYPE html>
<html lang="ru">
<head>
<meta charset="UTF-8">
<title>Mini Web OS</title>
<style>
html, body {margin:0; padding:0; height:100%; font-family:Arial,sans-serif; overflow:hidden;}
body {background: linear-gradient(135deg,#1e3c72,#2a5298); color:white;}

/* Login */
#login {position:absolute; top:50%; left:50%; transform:translate(-50%,-50%); background: rgba(0,0,0,0.8); padding:40px; border-radius:15px; width:320px; text-align:center;}
#login input, #login button {display:block; width:80%; margin:10px auto; padding:10px; font-size:16px; border-radius:8px; border:none;}
#login button {cursor:pointer; background:#ffcc00; color:#222; font-weight:bold;}
#login button:hover{background:#ffee66;}
#message{color:#ff4444; font-weight:bold;}

/* Desktop */
#desktop{display:none; width:100%; height:100%; position:relative;}
#desktop #taskbar{position:absolute; top:0; right:0; width:60px; height:100%; background:#111; display:flex; flex-direction:column; align-items:center; padding:10px 0;}
#taskbar button{width:40px; height:40px; margin:10px 0; background:#222; border:none; border-radius:8px; cursor:pointer; display:flex; align-items:center; justify-content:center;}
#taskbar button:hover{background:#444;}
#taskbar span{writing-mode: vertical-rl; transform: rotate(180deg); margin-top:10px; font-weight:bold; font-size:14px;}

/* Icons on desktop */
.icons{position:absolute; top:20px; left:20px; display:flex; flex-wrap:wrap; gap:15px;}
.icon{width:60px; height:60px; display:flex; flex-direction:column; align-items:center; cursor:pointer;}
.icon img{width:40px; height:40px;}
.icon span{margin-top:5px; font-size:12px; text-align:center;}

/* App windows */
.appWindow{position:absolute; top:50px; left:50%; transform:translateX(-50%); width:80%; max-width:700px; height:300px; background:#222; border:3px solid #555; border-radius:10px; display:none; overflow:hidden;}
.appWindow header{background:#333; padding:5px; cursor:move; display:flex; justify-content:space-between; align-items:center;}
.appWindow header span{font-weight:bold;}
.appWindow header button{background:#ff4444; border:none; border-radius:5px; width:25px; height:25px; cursor:pointer;}
.appContent{padding:10px; width:100%; height:calc(100% - 35px); overflow:auto; position:relative;}

/* Game styles */
#player{width:40px;height:40px;position:absolute;bottom:0;left:50px;opacity:1;transition:opacity 0.5s;}
.obstacle{width:30px;height:50px;background:red;position:absolute;bottom:0;right:-40px;animation:move 3s linear forwards;}
@keyframes move{from{right:-40px;}to{right:820px;}}
#score{position:absolute; top:10px; left:10px; font-weight:bold; color:#fff;}
#gameover{position:absolute; top:40%; left:50%; transform:translate(-50%,-50%); font-size:24px; font-weight:bold; color:#ff4444; display:none;}
#jumpBtn{position:absolute;bottom:10px;right:10px;width:80px;height:40px;background:#00ccff;color:#222;border:none;border-radius:8px; cursor:pointer;}
#jumpBtn:hover{background:#66eeff;}
</style>
</head>
<body>

<!-- Login -->
<div id="login">
  <h2>–í—Ö–æ–¥ / –†–µ–≥–∏—Å—Ç—Ä–∞—Ü–∏—è</h2>
  <input type="email" id="email" placeholder="Email">
  <input type="password" id="password" placeholder="–ü–∞—Ä–æ–ª—å">
  <button id="registerBtn">–ó–∞—Ä–µ–≥–∏—Å—Ç—Ä–∏—Ä–æ–≤–∞—Ç—å—Å—è</button>
  <button id="loginBtn">–í–æ–π—Ç–∏</button>
  <div id="message"></div>
</div>

<!-- Desktop -->
<div id="desktop">
  <div class="icons">
    <div class="icon" onclick="openApp('gameApp')"><img src="cube.png"><span>–ò–≥—Ä–∞</span></div>
    <div class="icon" onclick="openApp('musicApp')"><img src="music_icon.png"><span>–ú—É–∑—ã–∫–∞</span></div>
    <div class="icon" onclick="openApp('profileApp')"><img src="profile_icon.png"><span>–ü—Ä–æ—Ñ–∏–ª—å</span></div>
  </div>
  <div id="taskbar">
    <button onclick="openApp('gameApp')">üéÆ</button>
    <button onclick="openApp('musicApp')">üéµ</button>
    <button onclick="openApp('profileApp')">üë§</button>
    <span id="userNick">–ò–≥—Ä–æ–∫</span>
    <button onclick="logout()">‚èª</button>
  </div>
</div>

<!-- App Windows -->
<div id="gameApp" class="appWindow">
  <header><span>–ò–≥—Ä–∞</span><button onclick="closeApp('gameApp')">‚úñ</button></header>
  <div class="appContent">
    <div id="score">–û—á–∫–∏:0</div>
    <div id="gameover">–ò–≥—Ä–∞ –æ–∫–æ–Ω—á–µ–Ω–∞! –ù–∞–∂–º–∏ Enter</div>
    <img id="player" src="cube.png">
    <button id="jumpBtn">–ü—Ä—ã–∂–æ–∫</button>
    <audio id="bgMusic" src="music.mp3" loop></audio>
  </div>
</div>

<div id="musicApp" class="appWindow">
  <header><span>–ú—É–∑—ã–∫–∞</span><button onclick="closeApp('musicApp')">‚úñ</button></header>
  <div class="appContent">
    <audio controls loop style="width:100%" src="music.mp3"></audio>
  </div>
</div>

<div id="profileApp" class="appWindow">
  <header><span>–ü—Ä–æ—Ñ–∏–ª—å</span><button onclick="closeApp('profileApp')">‚úñ</button></header>
  <div class="appContent">
    <input type="text" id="nickInput" placeholder="–í–≤–µ–¥–∏—Ç–µ –Ω–∏–∫">
    <button id="saveNickBtn">–°–æ—Ö—Ä–∞–Ω–∏—Ç—å –Ω–∏–∫</button>
  </div>
</div>

<script type="module">
import { initializeApp } from "https://www.gstatic.com/firebasejs/11.0.1/firebase-app.js";
import { getAuth, createUserWithEmailAndPassword, signInWithEmailAndPassword, onAuthStateChanged, signOut } from "https://www.gstatic.com/firebasejs/11.0.1/firebase-auth.js";
import { getFirestore, doc, getDoc, setDoc } from "https://www.gstatic.com/firebasejs/11.0.1/firebase-firestore.js";

const firebaseConfig = {
  apiKey: "AIzaSyC8lcLregxdwR6GBSrkMqlWoZNdUuU3jdM",
  authDomain: "chat-ca735.firebaseapp.com",
  projectId: "chat-ca735",
  storageBucket: "chat-ca735.firebasestorage.app",
  messagingSenderId: "407446630782",
  appId: "1:407446630782:web:db7293a24c6e6445ebc32f"
};
const app = initializeApp(firebaseConfig);
const auth = getAuth(app);
const db = getFirestore(app);

// DOM
const loginDiv=document.getElementById("login");
const desktop=document.getElementById("desktop");
const emailInput=document.getElementById("email");
const passwordInput=document.getElementById("password");
const registerBtn=document.getElementById("registerBtn");
const loginBtn=document.getElementById("loginBtn");
const messageDiv=document.getElementById("message");
const userNick=document.getElementById("userNick");

const nickInput=document.getElementById("nickInput");
const saveNickBtn=document.getElementById("saveNickBtn");

const gameApp=document.getElementById("gameApp");
const musicApp=document.getElementById("musicApp");
const profileApp=document.getElementById("profileApp");

const player=document.getElementById("player");
const jumpBtn=document.getElementById("jumpBtn");
const bgMusic=document.getElementById("bgMusic");
const scoreElement=document.getElementById("score");
const gameOverText=document.getElementById("gameover");

let jumping=false, alive=true, score=0;

// –†–µ–≥–∏—Å—Ç—Ä–∞—Ü–∏—è
registerBtn.addEventListener("click",async()=>{
  const email=emailInput.value, password=passwordInput.value;
  if(!email||!password){messageDiv.textContent="–í–≤–µ–¥–∏—Ç–µ email –∏ –ø–∞—Ä–æ–ª—å"; return;}
  try{await createUserWithEmailAndPassword(auth,email,password);}catch(e){messageDiv.textContent=e.message;}
});
// –í—Ö–æ–¥
loginBtn.addEventListener("click",async()=>{
  const email=emailInput.value, password=passwordInput.value;
  if(!email||!password){messageDiv.textContent="–í–≤–µ–¥–∏—Ç–µ email –∏ –ø–∞—Ä–æ–ª—å"; return;}
  try{await signInWithEmailAndPassword(auth,email,password);}catch(e){messageDiv.textContent=e.message;}
});
// –°–µ—Å—Å–∏—è
onAuthStateChanged(auth,async user=>{
  if(user){
    loginDiv.style.display="none";
    desktop.style.display="block";
    const docRef=doc(db,"users",user.uid);
    const docSnap=await getDoc(docRef);
    if(docSnap.exists()){ userNick.textContent=docSnap.data().nick||"–ò–≥—Ä–æ–∫"; nickInput.value=docSnap.data().nick||"";}
    else userNick.textContent="–ò–≥—Ä–æ–∫";
    startGame();
  }else{loginDiv.style.display="block"; desktop.style.display="none";}
});

// –í—ã—Ö–æ–¥
function logout(){signOut(auth);}

// –°–æ—Ö—Ä–∞–Ω–µ–Ω–∏–µ –Ω–∏–∫–∞
saveNickBtn.addEventListener("click",async()=>{
  const user=auth.currentUser;
  if(!user) return;
  const nick=nickInput.value||"–ò–≥—Ä–æ–∫";
  await setDoc(doc(db,"users",user.uid),{nick},{merge:true});
  userNick.textContent=nick;
});

// –û—Ç–∫—Ä—ã—Ç–∏–µ/–∑–∞–∫—Ä—ã—Ç–∏–µ –ø—Ä–∏–ª–æ–∂–µ–Ω–∏–π
function openApp(appId){[gameApp,musicApp,profileApp].forEach(a=>a.style.display='none'); 
if(appId==="gameApp") gameApp.style.display='block';
if(appId==="musicApp") musicApp.style.display='block';
if(appId==="profileApp") profileApp.style.display='block';
}
function closeApp(appId){document.getElementById(appId).style.display='none';}

// –ü—Ä—ã–∂–æ–∫
function jump(){if(jumping||!alive) return; jumping=true; let pos=0; const up=setInterval(()=>{if(pos>=100){clearInterval(up); const down=setInterval(()=>{if(pos<=0){clearInterval(down); jumping=false;}else pos-=5; player.style.bottom=pos+"px";},20);}else{pos+=5;player.style.bottom=pos+"px";}},20);}
jumpBtn.addEventListener("click",jump);

// –ò–≥—Ä–∞
function startGame(){
  function spawnObstacle(){
    if(!alive) return;
    const obstacle=document.createElement("div"); obstacle.classList.add("obstacle"); gameApp.querySelector(".appContent").appendChild(obstacle);
    const checkCollision=setInterval(()=>{
      const pR=player.getBoundingClientRect(), oR=obstacle.getBoundingClientRect();
      if(pR.right>oR.left && pR.left<oR.right && pR.bottom>oR.top){alive=false; gameOverText.style.display="block"; clearInterval(checkCollision); bgMusic.pause();}
    },10);
    obstacle.addEventListener("animationend",()=>{obstacle.remove(); if(alive){score++; scoreElement.textContent="–û—á–∫–∏:"+score;}});
    setTimeout(spawnObstacle,Math.random()*2000+1000);
  }
  document.addEventListener("keydown",e=>{if(e.code==="Space") jump(); if(e.code==="Enter"&&!alive) location.reload();});
  spawnObstacle();
}
</script>
</body>
</html>