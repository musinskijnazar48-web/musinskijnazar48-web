<!DOCTYPE html>
<html lang="ru">
<head>
<meta charset="UTF-8">
<title>Mini Web OS</title>
<style>
html, body {margin:0; padding:0; height:100%; font-family:Arial,sans-serif;}
body {background: linear-gradient(90deg,#0f0c29,#302b63,#24243e); color:white; overflow:hidden;}
#login {text-align:center; background: rgba(0,0,0,0.7); padding:40px; border-radius:15px; width:90%; max-width:400px; margin:auto; margin-top:50px;}
input, button {display:block; margin:15px auto; padding:12px; width:80%; font-size:18px; border-radius:8px; border:none; outline:none;}
button {cursor:pointer; background:#ffcc00; color:#222; transition:0.3s;}
button:hover {background:#ffee66;}
#message{color:#ff4444;}
#desktop {display:none; width:100%; height:100%; position:relative;}
#panel {position:absolute; top:0; left:0; right:0; height:50px; background:#111; display:flex; align-items:center; justify-content:space-between; padding:0 10px;}
#panel span{font-weight:bold;}
.app-icons {display:flex; gap:10px; margin-top:60px; padding:10px;}
.app-icons button{width:120px; height:120px; font-size:16px; border-radius:15px;}
.appWindow {display:none; position:absolute; top:70px; left:50%; transform:translateX(-50%); width:90%; max-width:800px; height:300px; background:#222; border:3px solid #555; border-radius:10px; overflow:hidden; padding:10px;}
#player{width:40px;height:40px;position:absolute;bottom:0;left:50px;opacity:0;transition:opacity 1s;}
.obstacle{width:30px;height:50px;background:red;position:absolute;bottom:0;right:-40px;animation:move 3s linear forwards;}
@keyframes move{from{right:-40px;}to{right:820px;}}
#score{position:absolute;top:10px;left:10px;font-weight:bold;}
#gameover{position:absolute;top:40%;left:50%;transform:translate(-50%,-50%);font-size:24px;font-weight:bold;display:none;color:#ff4444;}
#jumpBtn{position:absolute;bottom:10px;right:10px;width:80px;height:40px;background:#00ccff;color:#222;border:none;border-radius:8px;cursor:pointer;}
#jumpBtn:hover{background:#66eeff;}
</style>
</head>
<body>

<div id="login">
  <h1>Вход / Регистрация</h1>
  <input type="email" id="email" placeholder="Email">
  <input type="password" id="password" placeholder="Пароль">
  <button id="registerBtn">Зарегистрироваться</button>
  <button id="loginBtn">Войти</button>
  <div id="message"></div>
</div>

<div id="desktop">
  <div id="panel">
    <span id="userNick">Игрок</span>
    <button id="logoutBtn">Выйти</button>
  </div>
  <div class="app-icons">
    <button onclick="openApp('gameApp')">Игры</button>
    <button onclick="openApp('musicApp')">Музыка</button>
    <button onclick="openApp('profileApp')">Профиль</button>
  </div>
</div>

<!-- Окна приложений -->
<div id="gameApp" class="appWindow">
  <div id="score">Очки: 0</div>
  <div id="gameover">Игра окончена! Нажми Enter для рестарта</div>
  <img id="player" src="cube.png" alt="Игрок">
  <button id="jumpBtn">Прыжок</button>
  <audio id="bgMusic" src="music.mp3" loop></audio>
</div>

<div id="musicApp" class="appWindow">
  <h3>Музыкальный плеер</h3>
  <audio controls loop style="width:100%;" src="music.mp3"></audio>
</div>

<div id="profileApp" class="appWindow">
  <h3>Профиль</h3>
  <input type="text" id="nickInput" placeholder="Введите ник">
  <button id="saveNickBtn">Сохранить ник</button>
</div>

<script type="module">
import { initializeApp } from "https://www.gstatic.com/firebasejs/11.0.1/firebase-app.js";
import { getAuth, createUserWithEmailAndPassword, signInWithEmailAndPassword, onAuthStateChanged } from "https://www.gstatic.com/firebasejs/11.0.1/firebase-auth.js";
import { getFirestore, doc, getDoc, setDoc } from "https://www.gstatic.com/firebasejs/11.0.1/firebase-firestore.js";

const firebaseConfig = {
  apiKey: "AIzaSyC8lcLregxdwR6GBSrkMqlWoZNdUuU3jdM",
  authDomain: "chat-ca735.firebaseapp.com",
  projectId: "chat-ca735",
  storageBucket: "chat-ca735.firebasestorage.app",
  messagingSenderId: "407446630782",
  appId: "1:407446630782:web:db7293a24c6e6445ebc32f"
};

const app = initializeApp(firebaseConfig);
const auth = getAuth(app);
const db = getFirestore(app);

// DOM
const emailInput = document.getElementById("email");
const passwordInput = document.getElementById("password");
const registerBtn = document.getElementById("registerBtn");
const loginBtn = document.getElementById("loginBtn");
const messageDiv = document.getElementById("message");
const loginDiv = document.getElementById("login");
const desktop = document.getElementById("desktop");
const userNick = document.getElementById("userNick");
const logoutBtn = document.getElementById("logoutBtn");

const nickInput = document.getElementById("nickInput");
const saveNickBtn = document.getElementById("saveNickBtn");

const gameApp = document.getElementById("gameApp");
const musicApp = document.getElementById("musicApp");
const profileApp = document.getElementById("profileApp");

const player = document.getElementById("player");
const jumpBtn = document.getElementById("jumpBtn");
const bgMusic = document.getElementById("bgMusic");
const scoreElement = document.getElementById("score");
const gameOverText = document.getElementById("gameover");

let jumping=false, alive=true, score=0;

// Регистрация
registerBtn.addEventListener("click", async ()=>{
  const email=emailInput.value;
  const password=passwordInput.value;
  if(!email||!password){messageDiv.textContent="Введите email и пароль"; return;}
  try{ await createUserWithEmailAndPassword(auth,email,password); } catch(e){messageDiv.textContent=e.message;}
});

// Вход
loginBtn.addEventListener("click", async ()=>{
  const email=emailInput.value;
  const password=passwordInput.value;
  if(!email||!password){messageDiv.textContent="Введите email и пароль"; return;}
  try{ await signInWithEmailAndPassword(auth,email,password); } catch(e){messageDiv.textContent=e.message;}
});

// Сессия
onAuthStateChanged(auth, async user=>{
  if(user){
    loginDiv.style.display="none";
    desktop.style.display="block";
    // Загрузка ника
    const docRef = doc(db,"users",user.uid);
    const docSnap = await getDoc(docRef);
    if(docSnap.exists()){ userNick.textContent=docSnap.data().nick||"Игрок"; nickInput.value=docSnap.data().nick||""; } 
    else{userNick.textContent="Игрок";}
    startGame();
  } else {loginDiv.style.display="block"; desktop.style.display="none";}
});

// Выход
logoutBtn.addEventListener("click", ()=>auth.signOut());

// Сохранение ника
saveNickBtn.addEventListener("click", async ()=>{
  const user=auth.currentUser;
  if(!user) return;
  const nick=nickInput.value||"Игрок";
  await setDoc(doc(db,"users",user.uid),{nick},{merge:true});
  userNick.textContent=nick;
});

// Открытие приложений
function openApp(appId){
  [gameApp,musicApp,profileApp].forEach(a=>a.style.display='none');
  if(appId==="gameApp") gameApp.style.display='block';
  if(appId==="musicApp") musicApp.style.display='block';
  if(appId==="profileApp") profileApp.style.display='block';
}

// Прыжок
function jump(){
  if(jumping||!alive) return;
  jumping=true;
  let pos=0;
  const up=setInterval(()=>{
    if(pos>=100){clearInterval(up);
      const down=setInterval(()=>{
        if(pos<=0){clearInterval(down); jumping=false;}
        else{pos-=5; player.style.bottom=pos+"px";}
      },20);
    } else {pos+=5; player.style.bottom=pos+"px";}
  },20);
}
jumpBtn.addEventListener("click", jump);

// Игра
function startGame(){
  function spawnObstacle(){
    if(!alive) return;
    const obstacle=document.createElement("div");
    obstacle.classList.add("obstacle");
    gameApp.appendChild(obstacle);

    const checkCollision=setInterval(()=>{
      const pR=player.getBoundingClientRect();
      const oR=obstacle.getBoundingClientRect();
      if(pR.right>oR.left && pR.left<oR.right && pR.bottom>oR.top){
        alive=false; gameOverText.style.display="block"; clearInterval(checkCollision); bgMusic.pause();
      }
    },10);

    obstacle.addEventListener("animationend",()=>{
      obstacle.remove();
      if(alive){score++; scoreElement.textContent="Очки: "+score;}
    });

    setTimeout(spawnObstacle, Math.random()*2000+1000);
  }

  document.addEventListener("keydown",(e)=>{
    if(e.code==="Space") jump();
    if(e.code==="Enter" && !alive) location.reload();
  });

  spawnObstacle();
}
</script>
</body>
</html>